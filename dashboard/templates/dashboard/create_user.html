{% extends 'dashboard/dashboard.html' %} 
{% load static %}
{% load widget_tweaks %}

{% block page_title %}
    <!-- Header with Collapse Toggle -->
    <div class="d-flex justify-content-between align-items-center w-100">
        
        <!-- Toggle Header -->
        <div class="d-flex align-items-center" 
             data-bs-toggle="collapse" 
             data-bs-target="#userFormCollapse" 
             aria-expanded="true" 
             aria-controls="userFormCollapse" 
             style="cursor: pointer;">
            
            <i class="bi bi-chevron-up me-2 fs-5 text-secondary"></i>
            <h4 style="margin-left: 10px; font-weight: bold; color: #333;">{{ page_title }}</h4>
        </div>
        
        <!-- CREATE NEW USER Button (This just reloads the create page) -->
        <div class="flex-grow-1 text-center"> 
             <a href="{% url 'create_user' %}" class="btn btn-sm btn-warning text-decoration-none fw-bold">CREATE NEW USER</a>
        </div>
    </div>
    <hr class="mt-0 mb-3"> 
{% endblock page_title %}

{% block main_content %}
    <div class="container-fluid py-4">
        
        <!-- Collapsible Form Section -->
        <div id="userFormCollapse" class="collapse show"> 
            
            <form method="POST">
                {% csrf_token %}
                <div class="row g-3">
                    
                    {# Row 1: Username and Full Name #}
                    <div class="col-md-6">
                        <label class="form-label">Username (Login ID)</label>
                        {% render_field form.username class="form-control" placeholder="e.g., amit" %}
                        {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors|first }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Full Name</label>
                        {% render_field form.full_name class="form-control" placeholder="e.g., Amit Kumar" %}
                    </div>

                    {# Row 2: Email and Phone Number #}
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        {% render_field form.email class="form-control" placeholder="e.g., amit@example.com" %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone Number</label>
                        {% render_field form.phone_number class="form-control" placeholder="e.g., +8801..." %}
                    </div>

                    <!-- === PASSWORD FIELDS === -->
                    <div class="col-md-6">
                        {% if form.instance.pk %}
                            <!-- This is the UPDATE form (UserUpdateForm) -->
                            <label class="form-label">New Password (Optional)</label>
                            <div class="form-text mt-0 mb-1">Leave blank to keep current password.</div>
                            {{ form.password|add_class:"form-control" }} <!-- Renders 'password' -->
                            {% if form.password.errors %}<div class="text-danger small">{{ form.password.errors|first }}</div>{% endif %}
                        {% else %}
                            <!-- This is the CREATE form (UserCreateForm) -->
                            <label class="form-label">Password</label>
                            {{ form.password1|add_class:"form-control" }} <!-- Renders 'password1' -->
                            {% if form.password1.errors %}<div class="text-danger small">{{ form.password1.errors|first }}</div>{% endif %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if form.instance.pk %}
                            <!-- This is the UPDATE form (UserUpdateForm) -->
                            <label class="form-label">Confirm New Password</label>
                        {% else %}
                            <!-- This is the CREATE form (UserCreateForm) -->
                            <label class="form-label">Confirm Password</label>
                        {% endif %}
                        
                        <!-- 'password2' is the correct name for both forms -->
                        {{ form.password2|add_class:"form-control" }}
                        {% if form.password2.errors %}<div class="text-danger small">{{ form.password2.errors|first }}</div>{% endif %}
                    </div>
                    <!-- === END PASSWORD FIELDS === -->
                    
                    {# Row 4: Primary Role and Active Status (Active only shows on Edit) #}
                    <div class="col-md-6">
                        <label class="form-label">Primary Role</label>
                        {% render_field form.primary_role class="form-select" %}
                        {% if form.primary_role.errors %}<div class="text-danger small">{{ form.primary_role.errors|first }}</div>{% endif %}
                    </div>
                    
                    {% if form.instance.pk %} <!-- Only show Active status on Edit -->
                    <div class="col-md-6">
                        <label class="form-label">Status</label>
                        {% render_field form.is_active class="form-select" %}
                    </div>
                    {% endif %}

                    <!-- === WAREHOUSE & ROLE ASSIGNMENT (Your M2M Requirement) === -->
                    <hr class="mt-4">
                    <h5>Assign Warehouse(s) and Role(s)</h5>
                    <p class="text-muted small">Select one or more warehouses and one or more roles. The user will be assigned all selected roles for all selected warehouses.</p>
                    
                    <div class="col-md-6">
                        <label class="form-label">Warehouses to Assign</label>
                        <select name="warehouses" class="form-select" multiple size="5">
                            {% for warehouse in all_warehouses %}
                                <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Hold Ctrl (or Cmd on Mac) to select multiple.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Roles to Assign</label>
                        <select name="roles" class="form-select" multiple size="5">
                            {% for role in all_roles %}
                                <option value="{{ role.id }}">{{ role.get_name_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- === END M2M ASSIGNMENT === -->
                    
                    {# Action Buttons #}
                    <div class="col-12 text-end mt-4">
                        <button type="submit" class="btn btn-warning me-2"><i class="bi bi-save me-2"></i> SAVE USER</button>
                        <a href="{% url 'create_user' %}" class="btn btn-secondary"><i class="bi bi-x me-2"></i> CANCEL</a>
                    </div>

                </div>
            </form>
            
        </div>
        
        <!-- User List Table -->
        <h5 class="mt-5 text-secondary">Existing Users</h5>
        <div class="card shadow-sm mt-3">
            <div class="card-body">
                
                <!-- Search Bar -->
                <form method="GET" action="{% url 'create_user' %}" class="d-flex justify-content-end mb-3">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" placeholder="Search by name, username, email..." name="q" value="{{ query }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                </form>
                
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">SL</th>
                            <th scope="col">Username</th>
                            <th scope="col">Full Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Phone Number</th>
                            <th scope="col">Primary Role</th>
                            <th scope="col">Warehouse Assignments</th>
                            <th scope="col">Date Joined</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_obj in users_list %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user_obj.username }}</td>
                            <td>{{ user_obj.full_name|default:"--" }}</td>
                            <td>{{ user_obj.email|default:"--" }}</td>
                            <td>{{ user_obj.phone_number|default:"--" }}</td>
                            <td>{{ user_obj.get_primary_role_display }}</td>
                            <td>
                                <!-- Loop through the user's M2M assignments -->
                                {% for assignment in user_obj.userwarehouserole_set.all %}
                                    <span class="badge bg-secondary mb-1">
                                        {{ assignment.warehouse.name }}: {{ assignment.role.get_name_display }}
                                    </span><br>
                                {% empty %}
                                    <span class="text-muted small">No assignments</span>
                                {% endfor %}
                            </td>
                            <td>
                                {{ user_obj.date_joined|date:"Y-m-d H:i" }}
                            </td>
                            <td>
                                <!-- Permission Check for Edit Button -->
                                {% if user.primary_role == 'super_admin' or user.primary_role == 'warehouse_admin' %}
                                    <!-- Do not allow editing self (Super Admin) or other Super Admins -->
                                    {% if user_obj.primary_role != 'super_admin' %}
                                        <a href="{% url 'user_update' user_obj.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No users found.</td> 
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock main_content %}