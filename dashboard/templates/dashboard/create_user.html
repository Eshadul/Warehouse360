{% extends 'dashboard/dashboard.html' %} 
{% load static %}
{% load widget_tweaks %}

{% block page_title %}
    <!-- Header with Collapse Toggle -->
    <div class="d-flex justify-content-between align-items-center w-100">
        
        <!-- Toggle Header -->
        <div class="d-flex align-items-center" 
             data-bs-toggle="collapse" 
             data-bs-target="#userFormCollapse" 
             aria-expanded="true" 
             aria-controls="userFormCollapse" 
             style="cursor: pointer;">
            
            <i class="bi bi-chevron-up me-2 fs-5 text-secondary"></i>
            <h4 style="margin-left: 10px; font-weight: bold; color: #333;">{{ page_title }}</h4>
        </div>
        
        <!-- CREATE NEW USER Button (This just reloads the create page) -->
        <div class="flex-grow-1 text-center"> 
             <a href="{% url 'create_user' %}" class="btn btn-sm btn-warning text-decoration-none fw-bold">CREATE NEW USER</a>
        </div>
    </div>
    <hr class="mt-0 mb-3"> 
{% endblock page_title %}

{% block main_content %}
    <div class="container-fluid py-4">
        
        <!-- Collapsible Form Section -->
        <div id="userFormCollapse" class="collapse show"> 
            
            <!-- === MAIN USER FORM (CREATE/EDIT) === -->
            <form method="POST">
                {% csrf_token %}
                <div class="row g-3">
                    
                    {# Row 1: Username and Full Name #}
                    <div class="col-md-6">
                        <label class="form-label">Username (Login ID)</label>
                        {% render_field form.username class="form-control" placeholder="e.g., amit" %}
                        {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors|first }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Full Name</label>
                        {% render_field form.full_name class="form-control" placeholder="e.g., Amit Kumar" %}
                    </div>

                    {# Row 2: Email and Phone Number #}
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        {% render_field form.email class="form-control" placeholder="e.g., amit@example.com" %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone Number</label>
                        {% render_field form.phone_number class="form-control" placeholder="e.g., +8801..." %}
                    </div>

                    <!-- === PASSWORD FIELDS === -->
                    <div class="col-md-6">
                        {% if form.instance.pk %}
                            <!-- This is the UPDATE form (UserUpdateForm) -->
                            <label class="form-label">New Password (Optional)</label>
                            <div class="form-text mt-0 mb-1">Leave blank to keep current password.</div>
                            {{ form.password|add_class:"form-control" }} <!-- Renders 'password' -->
                            {% if form.password.errors %}<div class="text-danger small">{{ form.password.errors|first }}</div>{% endif %}
                        {% else %}
                            <!-- This is the CREATE form (UserCreateForm) -->
                            <label class="form-label">Password</label>
                            {{ form.password1|add_class:"form-control" }} <!-- Renders 'password1' -->
                            {% if form.password1.errors %}<div class="text-danger small">{{ form.password1.errors|first }}</div>{% endif %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if form.instance.pk %}
                            <!-- This is the UPDATE form (UserUpdateForm) -->
                            <label class="form-label">Confirm New Password</label>
                        {% else %}
                            <!-- This is the CREATE form (UserCreateForm) -->
                            <label class="form-label">Confirm Password</label>
                        {% endif %}
                        
                        <!-- 'password2' is the correct name for both forms -->
                        {{ form.password2|add_class:"form-control" }}
                        {% if form.password2.errors %}<div class="text-danger small">{{ form.password2.errors|first }}</div>{% endif %}
                    </div>
                    <!-- === END PASSWORD FIELDS === -->
                    
                    {# Row 4: Primary Role and Active Status (Active only shows on Edit) #}
                    <div class="col-md-6">
                        <label class="form-label">Primary Role</label>
                        {% render_field form.primary_role class="form-select" %}
                        {% if form.primary_role.errors %}<div class="text-danger small">{{ form.primary_role.errors|first }}</div>{% endif %}
                    </div>
                    
                    {% if form.instance.pk %} <!-- Only show Active status on Edit -->
                    <div class="col-md-6">
                        <label class="form-label">Status</label>
                        {% render_field form.is_active class="form-select" %}
                    </div>
                    {% endif %}
                    
                    {# Action Buttons for Main Form #}
                    <div class="col-12 text-end mt-4">
                        <!-- This button name 'save_user' is checked in views.py -->
                        <button type="submit" name="save_user" class="btn btn-warning me-2"><i class="bi bi-save me-2"></i> SAVE USER DETAILS</button>
                        <a href="{% url 'create_user' %}" class="btn btn-secondary"><i class="bi bi-x me-2"></i> CANCEL</a>
                    </div>

                </div>
            </form>
            
        </div> <!-- End of Collapsible Form Section -->


        <!-- === NEW: ADD ASSIGNMENT FORM (Only shows on EDIT page) === -->
        {% if user_to_edit %} <!-- user_to_edit is passed from the view if pk exists -->
        <div class="mt-5">
            <hr>
            <h5>Add New Assignment</h5>
            <p class="text-muted small">Assign this user a new role at a specific warehouse.</p>
            
            <form method="POST">
                {% csrf_token %}
                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Warehouse</label>
                        {% render_field assignment_form.warehouse class="form-select" %}
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Role</label>
                        {% render_field assignment_form.role class="form-select" %}
                    </div>
                    <div class="col-md-2">
                        <!-- This button name 'add_assignment' is checked in views.py -->
                        <button type="submit" name="add_assignment" class="btn btn-success w-100">
                            <i class="bi bi-plus-lg"></i> Add
                        </button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
        <!-- === END NEW ASSIGNMENT FORM === -->


        <!-- User List Table -->
        <h5 class="mt-5 text-secondary">Existing Users</h5>
        <div class="card shadow-sm mt-3">
            <div class="card-body">
                
                <!-- Search Bar -->
                <form method="GET" action="{% url 'create_user' %}" class="d-flex justify-content-end mb-3">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" placeholder="Search by name, username, email..." name="q" value="{{ query }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                </form>
                
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">SL</th>
                            <th scope="col">Username</th>
                            <th scope="col">Full Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Phone Number</th>
                            <th scope="col">Primary Role</th>
                            <th scope="col">Warehouse Assignments</th>
                            <th scope="col">Date Joined</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_obj in users_list %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user_obj.username }}</td>
                            <td>{{ user_obj.full_name|default:"--" }}</td>
                            <td>{{ user_obj.email|default:"--" }}</td>
                            <td>{{ user_obj.phone_number|default:"--" }}</td>
                            <td>{{ user_obj.get_primary_role_display }}</td>
                            <td>
                                <!-- Loop through the user's M2M assignments -->
                                {% for assignment in user_obj.userwarehouserole_set.all %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="badge bg-secondary">
                                            {{ assignment.warehouse.name }}: {{ assignment.role.get_name_display }}
                                        </span>
                                        <!-- === NEW: REMOVE BUTTON === -->
                                        <!-- This link points to the new delete view -->
                                        <a href="{% url 'delete_user_assignment' assignment.pk %}" 
                                           class="btn btn-sm btn-outline-danger p-0 px-1 ms-2" 
                                           style="font-size: 0.7rem;"
                                           onclick="return confirm('Are you sure you want to remove this assignment?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                {% empty %}
                                    <span class="text-muted small">No assignments</span>
                                {% endfor %}
                            </td>
                            <td>
                                {{ user_obj.date_joined|date:"Y-m-d H:i" }}
                            </td>
                            <td>
                                <!-- Permission Check for Edit Button -->
                                {% if user.primary_role == 'super_admin' or user.primary_role == 'warehouse_admin' %}
                                    {% if user_obj.primary_role != 'super_admin' %}
                                        <a href="{% url 'user_update' user_obj.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No users found.</td> 
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock main_content %}