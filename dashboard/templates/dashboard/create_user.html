{% extends 'dashboard/dashboard.html' %} 
{% load static %}
{% load widget_tweaks %}

{% block page_title %}
    <!-- Header with Collapse Toggle -->
    <div class="d-flex justify-content-between align-items-center w-100">
        
        <!-- Toggle Header -->
        <div class="d-flex align-items-center" 
             data-bs-toggle="collapse" 
             data-bs-target="#userFormCollapse" 
             aria-expanded="true" 
             aria-controls="userFormCollapse" 
             style="cursor: pointer;">
            
            <i class="bi bi-chevron-up me-2 fs-5 text-secondary"></i>
            <h4 style="margin-left: 10px; font-weight: bold; color: #333;">{{ page_title }}</h4>
        </div>
        
        <!-- CREATE NEW USER Button (Reloads page) -->
        <div class="flex-grow-1 text-center"> 
             <a href="{% url 'create_user' %}" class="btn btn-sm btn-warning text-decoration-none fw-bold">CREATE NEW USER</a>
        </div>
    </div>
    <hr class="mt-0 mb-3"> 
{% endblock page_title %}

{% block main_content %}
    <div class="container-fluid py-4">
        
        <!-- Collapsible Form Section -->
        <div id="userFormCollapse" class="collapse show"> 
            
            <!-- === MAIN USER FORM (CREATE/EDIT) === -->
            <form method="POST" id="mainUserForm">
                {% csrf_token %}
                <div class="row g-3">
                    
                    {# Row 1: Username and Full Name #}
                    <div class="col-md-6">
                        <label class="form-label">Username (Login ID)</label>
                        {% render_field form.username class="form-control" placeholder="e.g., amit" %}
                        {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors|first }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Full Name</label>
                        {% render_field form.full_name class="form-control" placeholder="e.g., Amit Kumar" %}
                    </div>

                    {# Row 2: Email and Phone Number #}
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        {% render_field form.email class="form-control" placeholder="e.g., amit@example.com" %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone Number</label>
                        {% render_field form.phone_number class="form-control" placeholder="e.g., +8801..." %}
                    </div>

                    <!-- === PASSWORD FIELDS === -->
                    <div class="col-md-6">
                        {% if form.instance.pk %}
                            <!-- This is the UPDATE form -->
                            <label class="form-label">New Password (Optional)</label>
                            <div class="form-text mt-0 mb-1">Leave blank to keep current password.</div>
                            {{ form.password|add_class:"form-control" }}
                            {% if form.password.errors %}<div class="text-danger small">{{ form.password.errors|first }}</div>{% endif %}
                        {% else %}
                            <!-- This is the CREATE form -->
                            <label class="form-label">Password</label>
                            {{ form.password1|add_class:"form-control" }}
                            {% if form.password1.errors %}<div class="text-danger small">{{ form.password1.errors|first }}</div>{% endif %}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if form.instance.pk %}
                            <label class="form-label">Confirm New Password</label>
                        {% else %}
                            <label class="form-label">Confirm Password</label>
                        {% endif %}
                        
                        {{ form.password2|add_class:"form-control" }}
                        {% if form.password2.errors %}<div class="text-danger small">{{ form.password2.errors|first }}</div>{% endif %}
                    </div>
                    <!-- === END PASSWORD FIELDS === -->
                    
                    {# Row 4: Primary Role and Active Status #}
                    <div class="col-md-6">
                        <label class="form-label">Primary Role</label>
                        {% render_field form.primary_role class="form-select" %}
                        {% if form.primary_role.errors %}<div class="text-danger small">{{ form.primary_role.errors|first }}</div>{% endif %}
                    </div>
                    
                    {% if form.instance.pk %} <!-- Only show Active status on Edit -->
                    <div class="col-md-6">
                        <label class="form-label">Status</label>
                        {% render_field form.is_active class="form-select" %}
                    </div>
                    {% endif %}
                    
                    <!-- ===================================================== -->
                    <!-- === NEW SECTION: INITIAL ASSIGNMENT (CREATE ONLY) === -->
                    <!-- ===================================================== -->
                    {% if not user_to_edit %}
                    <div class="col-12">
                        <hr class="mt-4 mb-3">
                        <h5 class="text-secondary mb-3">Initial Assignment</h5>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Assign Warehouse</label>
                        <!-- Added ID for JS -->
                        {% render_field assignment_form.warehouse class="form-select" id="id_warehouse" %}
                        {% if assignment_form.warehouse.errors %}
                            <div class="text-danger small">{{ assignment_form.warehouse.errors|first }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Assign Role</label>
                        <!-- Added ID for JS -->
                        {% render_field assignment_form.role class="form-select" id="id_role" %}
                        {% if assignment_form.role.errors %}
                            <div class="text-danger small">{{ assignment_form.role.errors|first }}</div>
                        {% endif %}
                    </div>

                    <!-- NEW STORE FIELD (Hidden by Default) -->
                    <div class="col-md-4" id="store_container" style="display: none;">
                        <label class="form-label">Assign Store</label>
                        <!-- Added ID for JS -->
                        {% render_field assignment_form.store class="form-select" id="id_store" %}
                        {% if assignment_form.store.errors %}
                            <div class="text-danger small">{{ assignment_form.store.errors|first }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <!-- ===================================================== -->
                    
                    {# Action Buttons for Main Form #}
                    <div class="col-12 text-end mt-4">
                        <button type="submit" name="save_user" class="btn btn-warning me-2">
                            <i class="bi bi-save me-2"></i> 
                            {% if user_to_edit %} SAVE USER DETAILS {% else %} CREATE USER & ASSIGN {% endif %}
                        </button>
                        <a href="{% url 'create_user' %}" class="btn btn-secondary"><i class="bi bi-x me-2"></i> CANCEL</a>
                    </div>

                </div>
            </form>
            
        </div> <!-- End of Collapsible Form Section -->


        <!-- === ADD ASSIGNMENT FORM (Only shows on EDIT page) === -->
        {% if user_to_edit %}
        <div class="mt-5">
            <hr>
            <h5>Add New Assignment</h5>
            <p class="text-muted small">Assign this user a new role at a specific warehouse.</p>
            
            <form method="POST" id="addAssignmentForm">
                {% csrf_token %}
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Warehouse</label>
                        <!-- We reuse IDs because this form logic is exclusive to Edit page in JS context usually, 
                             but to be safe, standard Django IDs work if they are the only ones visible -->
                        {% render_field assignment_form.warehouse class="form-select" id="id_warehouse" %}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Role</label>
                        {% render_field assignment_form.role class="form-select" id="id_role" %}
                    </div>
                    
                    <!-- Store Field for Edit Mode -->
                    <div class="col-md-3" id="store_container" style="display: none;">
                        <label class="form-label">Store</label>
                        {% render_field assignment_form.store class="form-select" id="id_store" %}
                    </div>

                    <div class="col-md-2">
                        <button type="submit" name="add_assignment" class="btn btn-success w-100">
                            <i class="bi bi-plus-lg"></i> Add
                        </button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
        <!-- === END ASSIGNMENT FORM === -->


        <!-- User List Table -->
        <h5 class="mt-5 text-secondary">Existing Users</h5>
        <div class="card shadow-sm mt-3">
            <div class="card-body">
                
                <!-- Search Bar -->
                <form method="GET" action="{% url 'create_user' %}" class="d-flex justify-content-end mb-3">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" placeholder="Search..." name="q" value="{{ query }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                </form>
                
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">SL</th>
                            <th scope="col">Username</th>
                            <th scope="col">Full Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Phone</th>
                            <th scope="col">Role</th>
                            <th scope="col">Assignments</th>
                            <th scope="col">Date Joined</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_obj in users_list %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user_obj.username }}</td>
                            <td>{{ user_obj.full_name|default:"--" }}</td>
                            <td>{{ user_obj.email|default:"--" }}</td>
                            <td>{{ user_obj.phone_number|default:"--" }}</td>
                            <td>{{ user_obj.get_primary_role_display }}</td>
                            <td>
                                {% for assignment in user_obj.userwarehouserole_set.all %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="badge bg-secondary">
                                            {{ assignment.warehouse.name }}
                                            {% if assignment.store %}
                                                / {{ assignment.store.store_name }}
                                            {% endif %}
                                            : {{ assignment.role.get_name_display }}
                                        </span>
                                        <a href="{% url 'delete_user_assignment' assignment.pk %}" 
                                           class="btn btn-sm btn-outline-danger p-0 px-1 ms-2" 
                                           onclick="return confirm('Remove assignment?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                {% empty %}
                                    <span class="text-muted small">No assignments</span>
                                {% endfor %}
                            </td>
                            <td>{{ user_obj.date_joined|date:"Y-m-d" }}</td>
                            <td>
                                {% if user.primary_role == 'super_admin' or user.primary_role == 'warehouse_admin' %}
                                    {% if user_obj.primary_role != 'super_admin' %}
                                        <a href="{% url 'user_update' user_obj.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                                        <a href="{% url 'user_delete' user_obj.id %}" class="btn btn-sm btn-outline-danger ms-1" onclick="return confirm('Delete user?');">Del</a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No users found.</td> 
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- === JAVASCRIPT FOR DYNAMIC DROPDOWNS === -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            
            // 1. FUNCTION: Toggle Store Field based on Role
            function toggleStoreField() {
                // Get the text of the selected option
                var roleText = $("#id_role option:selected").text().trim().toLowerCase();
                
                // Check if selected role contains "store manager"
                if (roleText.includes("store manager")) {
                    $("#store_container").fadeIn();
                    // Optional: Make it required if visible
                    $("#id_store").prop('required', true);
                } else {
                    $("#store_container").fadeOut();
                    $("#id_store").val(""); // Reset selection
                    $("#id_store").prop('required', false);
                }
            }

            // 2. FUNCTION: Fetch Stores based on Warehouse
            function fetchStores() {
                var url = "{% url 'ajax_load_stores' %}";  // Uses the URL pattern name
                var warehouseId = $("#id_warehouse").val();

                if (warehouseId) {
                    $.ajax({
                        url: url,
                        data: {
                            'warehouse_id': warehouseId
                        },
                        success: function (data) {
                            // Save the currently selected store (if any) to preserve state on error
                            var selectedStore = $("#id_store").val();
                            
                            $("#id_store").html('<option value="">---------</option>');
                            $.each(data, function (key, value) {
                                $("#id_store").append('<option value="' + value.id + '">' + value.store_name + '</option>');
                            });

                            // Re-select if value existed
                            if (selectedStore) {
                                $("#id_store").val(selectedStore);
                            }
                        }
                    });
                } else {
                    $("#id_store").html('<option value="">---------</option>');
                }
            }

            // EVENTS
            
            // A. When Role Changes -> Toggle Store Field
            $("#id_role").change(toggleStoreField);
            
            // B. When Warehouse Changes -> Fetch Stores
            $("#id_warehouse").change(fetchStores);

            // C. Run on Page Load (in case of form validation error/edit mode)
            toggleStoreField();
            
            // Only fetch stores on load if warehouse is selected and store is empty or we are reloading
            if ($("#id_warehouse").val()) {
                 // We might not want to overwrite the existing selection on edit page load
                 // unless we want to ensure the list is fresh. 
                 // For Create page, it's fine.
                 // If the dropdown is empty (except placeholder), fetch.
                 if ($("#id_store option").length <= 1) {
                     fetchStores();
                 }
            }
        });
    </script>
{% endblock main_content %}